---
title: Image Warp
description: Warps, rotates, scales and translates the previous frame's image, optionally using a GPU shader.
---

![Image Warp Effect](/content/preset-guide/image-warp.jpg){style="width: 50%;"}

The Image Warp effect is probably the most complex and versatile step in rendering a preset. Its main purpose is to
apply a small differential warping to the image of the last frame, creating the effect of motion.

Classic Milkdrop 1.x presets only supported warping based on U/V texture coordinate manipulation. Several parameters
could be manipulated:

- Translation: Applying an offset in the X and/or Y axis, moving the whole image into this direction.
- Rotation: Rotating the whole image around a user-defined center point by a specific angle.
- Scaling: Uniformly scale the image from or to a user-defined center point.
- Zoom: Applies an exponential zoom from or to a user-defined center point. The zoom amount and exponent can be
  configured.
- Warping: Creates a sine/cosine-based warping effect with configurable scale and speed.
- Texture Wrapping: If enabled, the image is wrapped around to the other side of the image when moved outside the
  visible area.

Starting with Milkdrop 2, in addition to the above U/V coordinate manipulation, a custom HLSL shader can be used to draw
any kind of effect. Within this shader, the original warp U/Vs can optionally be used, or the unwarped ones. The shader
can then either calculate its own warp effect, or even skip using the previous image at all and draw something
completely new, making this effect really powerful.

## Per-Pixel/Per-Vertex Mesh

The Image Warp effect uses a grid, called either Per-Pixel or Per-Vertex, to calculate the U/V coordinates at different
positions on the screen.

The resolution of the grid can only be set by the user in the application settings. In most cases, it'll have a
resolution between 48x32 points up to 128x96. Higher resolutions often don't have any visual impact, but increase the
CPU load significantly. If the resolution is set too low, the warping may look as intended as the U/V coordinates are
linearly interpolated between the grid vertices.

For each point in that grid, the `per_pixel_` code block is being executed, passing in the X/Y coordinates of the point.
This code can then set the different parameters controlling the Image Warp effect. This allows for more complex warping
effects than only using the global default values for each parameter.

## Default Settings

| .milk Setting Key | Type  | Range   | Description                                                                                             |
|-------------------|-------|---------|---------------------------------------------------------------------------------------------------------|
| dx                | FLOAT | -1 .. 1 | Amount of constant horizontal motion.<br>(-0.01 = move left 1% per frame, 0=none, 0.01 = move right 1%) |
| dy                | FLOAT | -1 .. 1 | Amount of constant vertical motion.<br>(-0.01 = move up 1% per frame, 0=none, 0.01 = move down 1%)      |
| rot               | FLOAT | -1 .. 1 | The amount of rotation.<br>(0=none, 0.1=slightly right, -0.1=slightly clockwise, 0.1=CCW)               |
| cx                | FLOAT | 0 .. 1  | Where the center of rotation, zooming and stretching is, horizontally.<br>(0=left, 0.5=center, 1=right) |
| cy                | FLOAT | 0 .. 1  | Where the center of rotation, zooming and stretching is, vertically.<br>(0=top, 0.5=center, 1=bottom)   |
| sx                | FLOAT | \> 0    | Amount of constant horizontal stretching.<br>(0.99=shrink 1%, 1=normal, 1.01=stretch 1%)                |
| sy                | FLOAT | \> 0    | Amount of constant vertical stretching.<br>(0.99=shrink 1%, 1=normal, 1.01=stretch 1%)                  |
| zoom              | FLOAT | \> 0    | Inward/outward motion.<br>(0.9=zoom out 10% per frame, 1.0=no zoom, 1.1=zoom in 10%)                    |
| fZoomExponent     | FLOAT | \> 0    | The curvature of the zoom. (1=normal)                                                                   |
| warp              | FLOAT | \>= 0   | The magnitude of the warping.<br>(\>0=none, 1=normal, 2=major warping...)                               |
| fWarpScale        | FLOAT | \> 0    | The scale of the warp effect.                                                                           |
| fWarpAnimSpeed    | FLOAT | \>= 0   | The speed of the warp effect.                                                                           |
| bTexWrap          | BOOL  | 0 / 1   | Makes the warp effect "spill" around the canvas edges.                                                  |

## Expression Code Usage

All settings of the Image Warp Effect can be controlled using Milkdrop expression code in the following code blocks:

- `per_frame_init_`
- `per_frame_`
- `per_pixel_`

### Per-Frame Code

Most of the global default values as listed above can be used and changed in the `per_frame_init_` and `per_frame_`
blocks as follows:

| .milk Setting Key | Expression Variable | Writeable |
|-------------------|---------------------|-----------|
| dx                | dx                  | YES       |
| dy                | dy                  | YES       |
| rot               | rot                 | YES       |
| cx                | cx                  | YES       |
| cy                | cy                  | YES       |
| sx                | sx                  | YES       |
| sy                | sy                  | YES       |
| zoom              | zoom                | YES       |
| fZoomExponent     | zoomexp             | YES       | 
| warp              | warp                | YES       | 
| bTexWrap          | wrap                | YES       | 

**Notes:**

- The above values are not retained across frames.
- Each value will be set to the default value assigned in the .milk file at the start of each of the above code blocks.
- Any changes made to the variables in the `per_frame_init_` code are discarded and reset to defaults in the
  `per_frame_` block.

This means:

- Only read the values in the `per_frame_init_` bock, e.g. to init user-defined or global variables.
- An expression like `rot += 0.01;` will not animate the value, it'll instead add a constant value to the default one.

### Per-Pixel/Per-Vertex Code

For each vertex/point in the warp mesh, the `per_pixel_` code block is executed once. It can be used to individually
control the different Image Warp settings for each grid intersection, allowing for more complex warping patterns.

**Important:**  
Depending on the grid resolution set by the user, this code block can possibly be executed _several thousand times_ and
thus severely increase CPU usage if complex calculations are done here. It is highly recommended to keep the code inside
the `per_pixel_` block as simple and fast as possible, performing calculations which are not dependent on the actual
grid position in the `per_frame_` code and using `q##` and `reg##` variables to pass the values to the `per_pixel_`
code.

The following values relevant to the Image Warp effect are available in this code block, with variables of the same name
as noted in the Per-Frame code being set to the _output_ values of this code block:

| Variable | Writeable | Description                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| x        | NO        | Retrieves the x-position of the current pixel. At the very left edge of the screen this would be 0; in the middle, 0.5; and at the right, 1.                                                                                                                                                                                                                                                                                             |
| y        | NO        | Retrieves the y-position of the current pixel.  At the very top edge of the screen this would be 0; in the middle, 0.5; and at the bottom, 1.                                                                                                                                                                                                                                                                                            |
| rad      | NO        | Retrieves the distance of the pixel from the center of the screen. At the center of the screen this will be zero, and at the corners, 1.<br>(The middle of the edges will be 0.707 (half of the square root of 2).                                                                                                                                                                                                                       |
| ang      | NO        | Retrieves the angle of the current pixel, with respect to the center of the screen. If the point is to the right of the center, this is zero; above it, it is PI/2 (1.57); to the left, it is PI (3.14); and below, it is 4.71 (PI\*3/2). If it is just a dab below being directly to the right of the center of the screen, the value will approach 6.28 (PI*2).(Note: this is simply the arctangent of y over x, precomputed for you.) |
| dx       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| dy       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| rot      | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| cx       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| cy       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| sx       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| sy       | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| zoom     | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          |
| zoomexp  | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          | 
| warp     | YES       | [See above](#default-settings).                                                                                                                                                                                                                                                                                                                                                                                                          | 

**Notes:**

- The texture wrap setting is not available in this code block.
- Each value mapping to Per-Frame variables is set to the value it was set to at the end of the `per_frame_` code for
  each execution of this block.
- While some variables are marked as read-only, their values _can_ be changed within the expression, but are discarded
  once execution of the code finishes.

## Warp Shader

To use a shader for the Image Warp effect, the preset version must be set to at least `200` and the warp Pixel Shader
version to 2 or higher. If this is the case, and the `warp_` code block contains any text, the user-defined shader is
used instead of the built-in one.

The shader receives two texture coordinate inputs:

| Name    | Type   | Description                                                              |
|---------|--------|--------------------------------------------------------------------------|
| uv      | float2 | The warped texture coordinates as used by the classic Image Warp effect. |
| uv_orig | float2 | The original, unwarped 0..1 texture coordinates.                         |

For more information on writing Milkdrop shaders, pre-defined inputs and information on how to use external images as
textures, please see the [Shaders reference](/docs/preset-authoring/shaders).
