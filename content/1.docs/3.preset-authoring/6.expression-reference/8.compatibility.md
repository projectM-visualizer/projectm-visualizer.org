---
title: Compatibility
description: Known compatibility issues between Milkdrop and projectM.
---

While projectM strives to be as compatible to Milkdrop as possible, some incompatibilities can't be avoided due to
technical reasons.

The main difference between Milkdrop/ns-eel2 and projectM/projectm-eval is the way both parsers are implemented and
execute the final code:

- ns-eel2 builds a block of assembly code from the compilation result, while projectm-eval creates a tree-like data
  structure and calls C function for each tree node.
- ns-eel2's assembly instructions often do not check CPU flags after performing an operation, e.g. checking overflow and
  FPU exception bits. As a result, operations after such an issue may continue with an undefined CPU/register state.
  projectm-eval relies on the compiler to add proper checks.
- Some value conversions differ in both implementations, resulting in differing values being returned, e.g. if an over-
  or underflow happens.

Some mitigations have been added to projectm-eval to mimic the behavior of ns-eel2 where it is (mostly) deterministic:

- Division by zero returns `0` instead of `NaN`.
- In the `pow` function, if the base is `0` and the exponent negative, it returns `0` instead of `NaN`.

Other behaviors in ns-eel2 are hard or even impossible to emulate. The following list are some of the identified issues,
which do not (yet) have a compatible solution in projectm-eval and thus may cause presets to behave differently:

- In ns-eel2, the modulo operator precedence is broken in combination with subtraction of negative numbers in the form
  `a - b % c` if `b` is negative. For example, `x = 14; y = -5; res = x - y % 15` returns 9, calculated as
  `x (- y % 15)`, while projectm-eval returns the mathematically correct result 19, calculated as `x - (y % 15)`.
  A possible cause is that ns-eel2 wrongly assumes the `-` to be a unary operator in this special case.
- If overflows happen during float <-> int conversions, ns-eel2 may produce different results than projectm-eval, e.g.
  returning numbers with a different sign and/or value.
- If there are floating-point exceptions during the execution of a script, ns-eel2 may produce stable, but undefined
  results. In projectm-eval, such occasions may cause values to become `Inf` or `NaN`, which would propagate through the
  calculation and mess up the result in a different way. Note this heavily depends on how projectm-eval is compiled -
  when enabling fast-math optimizations, floating-point error handling may be disabled in a similar, but still different
  manner as in ns-eel2.
